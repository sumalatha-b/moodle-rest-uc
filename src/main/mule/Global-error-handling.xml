<?xml version="1.0" encoding="UTF-8"?> <mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation=" http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd"> <!-- One common subflow: (1) single set-variable httpStatus, (2) Transform Message --> <sub-flow name="common-error-message" doc:id="d204462d-8546-41c4-a57f-7c1f3fab484b"> <!-- SINGLE common Set Variable (no payload refs) --> <set-variable variableName="httpStatus" doc:name="Set httpStatus" value="#[%dw 2.0&#10; output application/json&#10;&#10; var id = ((error.errorType.identifier default '') as String)&#10;&#10; ---&#10; (id match {&#10; case 'BAD_REQUEST' -&gt; 400&#10; case 'CONNECTIVITY' -&gt; 502&#10; case 'FORBIDDEN' -&gt; 403&#10; case 'METHOD_NOT_ALLOWED' -&gt; 405&#10; case 'NOT_FOUND' -&gt; 404&#10; case 'UNAUTHORIZED' -&gt; 401&#10; case 'UNSUPPORTED_MEDIA_TYPE' -&gt; 415&#10; case 'NOT_ACCEPTABLE' -&gt; 406&#10; case 'NOT_IMPLEMENTED' -&gt; 501&#10; case 'UNKNOWN' -&gt; 400&#10; case 'EXPRESSION' -&gt; 400&#10; case 'INVALIDSCHEMA'-&gt; 422&#10; case 'CLIENT_ERROR' -&gt; 403&#10; case is &quot;TOO_MANY_REQUESTS&quot;-&gt; &quot;429&quot;&#10; else -&gt; 500&#10; })]"/> <!-- Keep your Transform Message exactly as before (no variables inside it) -->
		<ee:transform doc:name="Transform Message"> <ee:message> <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
(error.errorMessage.payload default "Unexpected error occurred")]]></ee:set-payload> </ee:message> </ee:transform> </sub-flow> <!-- Global Error Handler: call the common subflow; no per-route set-variable --> <error-handler name="Global-Error-Handler"> <on-error-propagate enableNotifications="true" logException="true" when='error.errorType.namespace == "APIKIT"'> <flow-ref name="common-error-message" doc:name="Flow Reference-APIKIT"/> </on-error-propagate> <on-error-propagate enableNotifications="true" logException="true" when='error.errorType.namespace == "MOODLE"'> <flow-ref name="common-error-message" doc:name="Flow Reference-MOODLE"/> </on-error-propagate> <on-error-propagate enableNotifications="true" logException="true" when='error.errorType.namespace == "ANY"'> <flow-ref name="common-error-message" doc:name="Flow Reference-ANY"/> </on-error-propagate> </error-handler> <!-- Example in HTTP Listener: <error-response statusCode="#[vars.httpStatus]"> <body><![CDATA[#[payload]]]></body> </error-response> --> </mule>